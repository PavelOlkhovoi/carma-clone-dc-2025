name: Manual E2E Tests
run-name: >
  ðŸ™Œ : Manual E2E Tests
on:
  workflow_dispatch:
    inputs:
      project-name:
        description: "Please enter a project name."
        required: true
        type: string
      live:
        description: "Run live tests"
        required: false
        type: boolean
        default: false
      smoke:
        description: "Run smoke tests"
        required: false
        type: boolean
        default: false
      flaky:
        description: "Run flaky tests"
        required: false
        type: boolean
        default: false

jobs:
  e2e:
    name: "E2E Tests: ${{ github.event.inputs['project-name'] }}"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: "recursive"
      - name: Update Submodules
        run: git submodule update --remote --recursive
      - name: Print Collaboration Version numbers
        run: |
          echo "-------------------------------"
          echo "All Collaboration Submodules:"
          echo
          find libraries -type f -name "package.json" -path "*/*-submodule/package.json" \
          -exec sh -c 'dir=$(dirname "$1"); echo "$(basename "$dir"): $(grep -m1 \"version\" "$1" | sed -E "s/[[:space:]]*\"version\":[[:space:]]*\"([^\"]+)\",/\\1/")"' _ {} \;
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: add cismet-dev registry secret to .npmrc
        shell: bash
        run: |
          touch .npmrc
          echo "${{ secrets.CISMET_DEV_REGISTRY_SECRET_4_DOT_NPMRC }}" >> .npmrc

      - name: Generate node_modules cache key
        id: node-cache-key
        run: |
          echo "key=node-modules-${{ runner.os }}-node-20-${{ hashFiles('package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Restore node_modules from cache
        id: e2e-manual-node-cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ steps.node-cache-key.outputs.key }}

      - name: Install dependencies
        if: steps.e2e-manual-node-cache.outputs.cache-hit != 'true'
        run: npm install

      - name: Run E2E tests
        if: github.event.inputs.live == 'true' || github.event.inputs.smoke == 'true' || github.event.inputs.flaky == 'true'
        run: |
          set -o pipefail

          # Build grep pattern dynamically based on selected inputs
          GREP_PATTERN=""

          if [ "${{ github.event.inputs.live }}" == "true" ]; then
            GREP_PATTERN="${GREP_PATTERN}live/"
          fi

          if [ "${{ github.event.inputs.smoke }}" == "true" ]; then
            if [ -n "$GREP_PATTERN" ]; then
              GREP_PATTERN="${GREP_PATTERN}|smoke/"
            else
              GREP_PATTERN="smoke/"
            fi
          fi

          if [ "${{ github.event.inputs.flaky }}" == "true" ]; then
            if [ -n "$GREP_PATTERN" ]; then
              GREP_PATTERN="${GREP_PATTERN}|flaky/"
            else
              GREP_PATTERN="flaky/"
            fi
          fi

          # Fallback to all test types if none selected
          if [ -z "$GREP_PATTERN" ]; then
            GREP_PATTERN="/"
          fi

          echo "Running tests with pattern: $GREP_PATTERN"
          PW_CHANNEL=chrome npx nx e2e e2e-${{ github.event.inputs['project-name'] }} --grep="$GREP_PATTERN" --skip-nx-cache --skipInstall --parallel=1 2>&1 | tee test_output.log
      - name: Report the live test failure
        if: failure() && !cancelled()
        run: |
          echo "Full test_output.log:"
          # grep -A20 "failed" test_output.log | grep -o "[a-zA-Z0-9_-]*\.spec\.ts" | sort -u
          grep -A20 "failed" test_output.log | grep -B20 "flaky" | sed '$d' | grep -o "[a-zA-Z0-9_-]*\.spec\.ts" | sort -u
          # Simple failed test extraction
          FAILED_TESTS=$(grep -o "[a-zA-Z0-9_-]*\.spec\.ts" test_output.log 2>/dev/null | sort -u | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')
          # FAILED_TESTS=$(grep -A20 "failed" test_output.log | grep -B20 "flaky" | sed '$d' | grep -o "[a-zA-Z0-9_-]*\.spec\.ts" | sort -u | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')

          # Create grep pattern from failed tests (fallback to live/ if no tests found)
          if [ -n "$FAILED_TESTS" ]; then
            GREP_PATTERN=$(echo "$FAILED_TESTS" | sed 's/, /|/g')
          else
            GREP_PATTERN="/"
          fi

          # Write summary
          {
            echo "## âŒ Failed Tests \`${{ github.event.inputs['project-name'] }}\`"
            echo "**Failed tests:** ${FAILED_TESTS:-Unknown}"
            echo ""
            echo "### ðŸ” Run locally:"
            echo '```bash'
            echo "npx nx e2e e2e-${{ github.event.inputs['project-name'] }} --grep=\"$GREP_PATTERN\" --skip-nx-cache --skipInstall --parallel=1"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
